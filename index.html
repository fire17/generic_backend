<!DOCTYPE html>
<html>
<head>
    <title>Backend API</title>
    <script>
        // Mock data store
        const mockDb = {
            todos: [
                { id: 1, text: "Buy groceries", completed: false, createdAt: "2024-11-26T10:00:00Z" },
                { id: 2, text: "Walk the dog", completed: true, createdAt: "2024-11-26T11:00:00Z" }
            ]
        };

        // Helper to parse URL query parameters
        function getQueryParams() {
            const hash = window.location.hash.substring(1);
            return Object.fromEntries(new URLSearchParams(hash));
        }

        // Handle API requests
        function handleRequest() {
            const params = getQueryParams();
            const action = params.action;
            const response = { success: true, data: null, error: null };

            try {
                switch (action) {
                    case 'getTodos':
                        response.data = mockDb.todos;
                        break;

                    case 'addTodo':
                        const newTodo = {
                            id: mockDb.todos.length + 1,
                            text: params.text,
                            completed: false,
                            createdAt: new Date().toISOString()
                        };
                        mockDb.todos.push(newTodo);
                        response.data = newTodo;
                        break;

                    case 'updateTodo':
                        const todoId = parseInt(params.id);
                        const todo = mockDb.todos.find(t => t.id === todoId);
                        if (todo) {
                            todo.completed = params.completed === 'true';
                            if (params.text) todo.text = params.text;
                            response.data = todo;
                        } else {
                            throw new Error('Todo not found');
                        }
                        break;

                    case 'deleteTodo':
                        const deleteId = parseInt(params.id);
                        const index = mockDb.todos.findIndex(t => t.id === deleteId);
                        if (index !== -1) {
                            mockDb.todos.splice(index, 1);
                            response.data = { id: deleteId };
                        } else {
                            throw new Error('Todo not found');
                        }
                        break;

                    default:
                        throw new Error('Invalid action');
                }
            } catch (error) {
                response.success = false;
                response.error = error.message;
            }

            // Send response back to parent window
            window.parent.postMessage(response, 'https://front.akeyo.io');
        }

        // Listen for messages from frontend
        window.addEventListener('message', (event) => {
            if (event.origin === 'https://front.akeyo.io') {
                handleRequest();
            }
        });
    </script>
</head>
<body>
    <h1>Backend API</h1>
    <p>This page serves as a mock API endpoint.</p>
</body>
</html>
