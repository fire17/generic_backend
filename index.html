<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend API</title>
</head>
<body>
    <script>
        // Mock database
        let todos = [
            { id: 1, text: "Example todo 1", createdAt: new Date().toISOString() },
            { id: 2, text: "Example todo 2", createdAt: new Date().toISOString() }
        ];
        let nextId = 3;

        // CORS headers
        const headers = {
            'Access-Control-Allow-Origin': 'https://front.akeyo.io',
            'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
            'Access-Control-Allow-Headers': 'Content-Type',
            'Content-Type': 'application/json'
        };

        // Handle all requests
        async function handleRequest(event) {
            event.preventDefault();
            const url = new URL(window.location.href);
            const path = url.pathname;
            const method = event.data?.method || 'GET';

            // Handle OPTIONS preflight requests
            if (method === 'OPTIONS') {
                return new Response(null, { headers });
            }

            // Route handling
            if (path === '/todos' && method === 'GET') {
                return new Response(JSON.stringify(todos), { headers });
            }
            
            if (path === '/todos' && method === 'POST') {
                const body = JSON.parse(event.data.body);
                const newTodo = {
                    id: nextId++,
                    text: body.text,
                    createdAt: new Date().toISOString()
                };
                todos.push(newTodo);
                return new Response(JSON.stringify({ success: true }), { headers });
            }
            
            if (path.startsWith('/todos/') && method === 'PUT') {
                const id = parseInt(path.split('/')[2]);
                const body = JSON.parse(event.data.body);
                const todoIndex = todos.findIndex(t => t.id === id);
                
                if (todoIndex !== -1) {
                    todos[todoIndex] = {
                        ...todos[todoIndex],
                        text: body.text
                    };
                    return new Response(JSON.stringify({ success: true }), { headers });
                }
                return new Response(JSON.stringify({ success: false }), { headers });
            }
            
            if (path.startsWith('/todos/') && method === 'DELETE') {
                const id = parseInt(path.split('/')[2]);
                todos = todos.filter(t => t.id !== id);
                return new Response(JSON.stringify({ success: true }), { headers });
            }

            return new Response(JSON.stringify({ error: 'Not Found' }), { 
                headers,
                status: 404 
            });
        }

        // Listen for requests
        window.addEventListener('message', handleRequest);
        
        // Initial setup to handle direct requests
        window.onload = () => {
            handleRequest({ preventDefault: () => {}, data: null });
        };
    </script>
</body>
</html>
